{"pair_id": "sql-case-001_p0", "cluster_id": "sql-case-001", "question": "How do I use CASE WHEN in the SQL target?", "question_type": "medium", "answer": "The SQL target provides `sql_case/2` for CASE WHEN expressions. The syntax is:\n\n```prolog\nsql_case([when(Condition1, Result1), when(Condition2, Result2), ...], DefaultValue)\n```\n\nHere's an example that categorizes employee salaries:\n\n```prolog\nsalary_category(Name, Category) :-\n    employees(_, Name, _, Salary, _, _),\n    Category = sql_case([\n        when(Salary > 100000, 'High'),\n        when(Salary > 60000, 'Medium')\n    ], 'Low').\n```\n\nThis compiles to:\n\n```sql\nCASE\n    WHEN salary > 100000 THEN 'High'\n    WHEN salary > 60000 THEN 'Medium'\n    ELSE 'Low'\nEND\n```\n\nThe conditions are checked sequentially, and the first matching condition determines the result. For more SQL target features, see education/book-10-sql-target/.", "answer_variant": "default", "answer_source": "book-10-sql-target/11_case_when.md", "topics": [], "original_answer": "Use `sql_case/2` for conditional logic:\n\n```prolog\nsql_case([when(Condition1, Result1), when(Condition2, Result2), ...], Default)\n```\n\nExample - categorize salaries:\n```prolog\nsalary_category(Name, Category) :-\n    employees(_, Name, _, Salary, _, _),\n    Category = sql_case([\n        when(Salary > 100000, 'High'),\n        when(Salary > 60000, 'Medium')\n    ], 'Low').\n```\n\nGenerates:\n```sql\nCASE\n    WHEN salary > 100000 THEN 'High'\n    WHEN salary > 60000 THEN 'Medium'\n    ELSE 'Low'\nEND\n```\n\nConditions are evaluated in order; first match wins.", "answer_tailored": true}
{"pair_id": "sql-case-001_p0", "cluster_id": "sql-case-001", "question": "How do I use CASE WHEN with aggregations?", "question_type": "medium", "answer": "To combine CASE WHEN expressions with aggregations, wrap the CASE expression inside aggregation functions like `sql_sum()` or `sql_count()`. This enables conditional aggregation - counting or summing only rows that meet specific criteria.\n\nExample using CASE WHEN for conditional counting by salary tier:\n\n```prolog\ndept_salary_breakdown(Dept, HighCount, MidCount, LowCount) :-\n    employees(_, _, Dept, Salary, _, _),\n    sql_group_by([Dept]),\n    HighCount = sql_sum(sql_case([when(Salary > 100000, 1)], 0)),\n    MidCount = sql_sum(sql_case([when((Salary > 60000, Salary =< 100000), 1)], 0)),\n    LowCount = sql_sum(sql_case([when(Salary =< 60000, 1)], 0)).\n```\n\nThis compiles to SQL with conditional sums:\n```sql\nSUM(CASE WHEN salary > 100000 THEN 1 ELSE 0 END) AS high,\nSUM(CASE WHEN salary > 60000 AND salary <= 100000 THEN 1 ELSE 0 END) AS mid,\nSUM(CASE WHEN salary <= 60000 THEN 1 ELSE 0 END) AS low\n```\n\nThis technique, known as pivot or cross-tabulation, lets you calculate multiple conditional metrics in a single query pass. For more on SQL target features, see education/book-10-sql-target/.", "answer_variant": "default", "answer_source": "book-10-sql-target/11_case_when.md", "topics": [], "original_answer": "Conditional counting and summing with CASE WHEN:\n\n```prolog\ndept_salary_breakdown(Dept, HighCount, MidCount, LowCount) :-\n    employees(_, _, Dept, Salary, _, _),\n    sql_group_by([Dept]),\n    HighCount = sql_sum(sql_case([when(Salary > 100000, 1)], 0)),\n    MidCount = sql_sum(sql_case([when((Salary > 60000, Salary =< 100000), 1)], 0)),\n    LowCount = sql_sum(sql_case([when(Salary =< 60000, 1)], 0)).\n```\n\nGenerates:\n```sql\nSUM(CASE WHEN salary > 100000 THEN 1 ELSE 0 END) AS high,\nSUM(CASE WHEN salary > 60000 AND salary <= 100000 THEN 1 ELSE 0 END) AS mid,\nSUM(CASE WHEN salary <= 60000 THEN 1 ELSE 0 END) AS low\n```\n\nThis pattern is called \"pivot\" or \"cross-tabulation\".", "answer_tailored": true}
{"pair_id": "sql-case-002_p0", "cluster_id": "sql-case-002", "question": "How do I use CASE WHEN for value mapping?", "question_type": "medium", "answer": "To map values using CASE WHEN in UnifyWeaver, use `sql_case/2` with a list of `when/2` conditions and a default value.\n\nFor mapping status codes to readable labels:\n\n```prolog\norder_status_display(Id, StatusDisplay) :-\n    orders(Id, _, _, Status, _),\n    StatusDisplay = sql_case([\n        when(Status = 'P', 'Pending'),\n        when(Status = 'S', 'Shipped'),\n        when(Status = 'D', 'Delivered'),\n        when(Status = 'C', 'Cancelled')\n    ], 'Unknown').\n```\n\nFor calculating values conditionally:\n```prolog\ndiscount_rate(Name, Price, Discount) :-\n    products(_, Name, Price, _, Category),\n    Discount = sql_case([\n        when(Category = 'Electronics', Price * 0.15),\n        when(Category = 'Clothing', Price * 0.20),\n        when(Category = 'Books', Price * 0.10)\n    ], Price * 0.05).\n```\n\nAdd column aliases with `sql_as/2`:\n```prolog\nTier = sql_as(sql_case([...], 'Default'), salary_tier)\n```\n\nSee education/book-10-sql-target/11_case_when.md for additional patterns.", "answer_variant": "default", "answer_source": "book-10-sql-target/11_case_when.md", "topics": [], "original_answer": "Map codes to display values:\n\n```prolog\norder_status_display(Id, StatusDisplay) :-\n    orders(Id, _, _, Status, _),\n    StatusDisplay = sql_case([\n        when(Status = 'P', 'Pending'),\n        when(Status = 'S', 'Shipped'),\n        when(Status = 'D', 'Delivered'),\n        when(Status = 'C', 'Cancelled')\n    ], 'Unknown').\n```\n\nCompute values based on conditions:\n```prolog\ndiscount_rate(Name, Price, Discount) :-\n    products(_, Name, Price, _, Category),\n    Discount = sql_case([\n        when(Category = 'Electronics', Price * 0.15),\n        when(Category = 'Clothing', Price * 0.20),\n        when(Category = 'Books', Price * 0.10)\n    ], Price * 0.05).\n```\n\nUse `sql_as/2` for column aliases:\n```prolog\nTier = sql_as(sql_case([...], 'Default'), salary_tier)\n```", "answer_tailored": true}
