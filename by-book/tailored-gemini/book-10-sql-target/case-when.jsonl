{"pair_id": "sql-case-001_p0", "cluster_id": "sql-case-001", "question": "How do I use CASE WHEN in the SQL target?", "question_type": "medium", "answer": "To use `CASE WHEN` logic within the SQL target, employ the `sql_case/2` predicate. This maps a list of Prolog conditions to a standard SQL `CASE` statement, providing a declarative way to handle branching logic in your queries.\n\nSyntax:\n```prolog\nsql_case([when(Condition1, Result1), when(Condition2, Result2), ...], DefaultValue)\n```\n\nExample - Categorizing salary levels:\n```prolog\nsalary_level(EmployeeName, Level) :-\n    employees(_, EmployeeName, _, Salary, _, _),\n    Level = sql_case([\n        when(Salary > 100000, 'High'),\n        when(Salary > 60000, 'Medium')\n    ], 'Low').\n```\n\nThe compiler transforms this into:\n```sql\nCASE\n    WHEN salary > 100000 THEN 'High'\n    WHEN salary > 60000 THEN 'Medium'\n    ELSE 'Low'\nEND\n```\n\nThe SQL engine evaluates these conditions in the order they are listed, returning the result for the first match found. You can find more comprehensive examples and details in `education/book-10-sql-target/11_case_when.md`.", "answer_variant": "default", "answer_source": "book-10-sql-target/11_case_when.md", "topics": [], "original_answer": "Use `sql_case/2` for conditional logic:\n\n```prolog\nsql_case([when(Condition1, Result1), when(Condition2, Result2), ...], Default)\n```\n\nExample - categorize salaries:\n```prolog\nsalary_category(Name, Category) :-\n    employees(_, Name, _, Salary, _, _),\n    Category = sql_case([\n        when(Salary > 100000, 'High'),\n        when(Salary > 60000, 'Medium')\n    ], 'Low').\n```\n\nGenerates:\n```sql\nCASE\n    WHEN salary > 100000 THEN 'High'\n    WHEN salary > 60000 THEN 'Medium'\n    ELSE 'Low'\nEND\n```\n\nConditions are evaluated in order; first match wins.", "answer_tailored": true}
{"pair_id": "sql-case-001_p0", "cluster_id": "sql-case-001", "question": "How do I use CASE WHEN with aggregations?", "question_type": "medium", "answer": "To use `CASE WHEN` within aggregations in UnifyWeaver, you nest the `sql_case/2` construct inside aggregate functions such as `sql_sum/1`. This enables conditional counting and summing, a pattern often referred to as \"pivot\" or \"cross-tabulation.\"\n\nExample Prolog definition for a department salary breakdown:\n```prolog\ndept_salary_breakdown(Dept, HighCount, MidCount, LowCount) :-\n    employees(_, _, Dept, Salary, _, _),\n    sql_group_by([Dept]),\n    HighCount = sql_sum(sql_case([when(Salary > 100000, 1)], 0)),\n    MidCount = sql_sum(sql_case([when((Salary > 60000, Salary =< 100000), 1)], 0)),\n    LowCount = sql_sum(sql_case([when(Salary =< 60000, 1)], 0)).\n```\n\nThe compiler transforms this into standard SQL aggregate expressions:\n```sql\nSUM(CASE WHEN salary > 100000 THEN 1 ELSE 0 END) AS high,\nSUM(CASE WHEN salary > 60000 AND salary <= 100000 THEN 1 ELSE 0 END) AS mid,\nSUM(CASE WHEN salary <= 60000 THEN 1 ELSE 0 END) AS low\n```\n\nDetailed documentation on conditional logic for the SQL target can be found in `education/book-10-sql-target/11_case_when.md`.", "answer_variant": "default", "answer_source": "book-10-sql-target/11_case_when.md", "topics": [], "original_answer": "Conditional counting and summing with CASE WHEN:\n\n```prolog\ndept_salary_breakdown(Dept, HighCount, MidCount, LowCount) :-\n    employees(_, _, Dept, Salary, _, _),\n    sql_group_by([Dept]),\n    HighCount = sql_sum(sql_case([when(Salary > 100000, 1)], 0)),\n    MidCount = sql_sum(sql_case([when((Salary > 60000, Salary =< 100000), 1)], 0)),\n    LowCount = sql_sum(sql_case([when(Salary =< 60000, 1)], 0)).\n```\n\nGenerates:\n```sql\nSUM(CASE WHEN salary > 100000 THEN 1 ELSE 0 END) AS high,\nSUM(CASE WHEN salary > 60000 AND salary <= 100000 THEN 1 ELSE 0 END) AS mid,\nSUM(CASE WHEN salary <= 60000 THEN 1 ELSE 0 END) AS low\n```\n\nThis pattern is called \"pivot\" or \"cross-tabulation\".", "answer_tailored": true}
{"pair_id": "sql-case-002_p0", "cluster_id": "sql-case-002", "question": "How do I use CASE WHEN for value mapping?", "question_type": "medium", "answer": "In UnifyWeaver, you perform value mapping and conditional logic for SQL targets using the `sql_case/2` construct. This allows you to define transformations that compile directly into SQL `CASE WHEN` statements.\n\nTo map specific codes to display labels:\n```prolog\norder_status_label(OrderId, Label) :-\n    orders(OrderId, _, _, Status, _),\n    Label = sql_case([\n        when(Status = 'P', 'Pending'),\n        when(Status = 'S', 'Shipped'),\n        when(Status = 'D', 'Delivered'),\n        when(Status = 'C', 'Cancelled')\n    ], 'Unknown').\n```\n\nYou can also use `sql_case` for conditional calculations, such as determining discount rates based on product categories:\n```prolog\ncompute_discount(Name, Price, Discount) :-\n    products(_, Name, Price, _, Category),\n    Discount = sql_case([\n        when(Category = 'Electronics', Price * 0.15),\n        when(Category = 'Clothing', Price * 0.20),\n        when(Category = 'Books', Price * 0.10)\n    ], Price * 0.05).\n```\n\nTo provide a column alias for the resulting value, wrap the expression with `sql_as/2`:\n```prolog\nResult = sql_as(sql_case([...], 'Default'), calculation_alias)\n```\n\nFor more information on SQL-specific predicates and code generation, see `education/book-10-sql-target/`.", "answer_variant": "default", "answer_source": "book-10-sql-target/11_case_when.md", "topics": [], "original_answer": "Map codes to display values:\n\n```prolog\norder_status_display(Id, StatusDisplay) :-\n    orders(Id, _, _, Status, _),\n    StatusDisplay = sql_case([\n        when(Status = 'P', 'Pending'),\n        when(Status = 'S', 'Shipped'),\n        when(Status = 'D', 'Delivered'),\n        when(Status = 'C', 'Cancelled')\n    ], 'Unknown').\n```\n\nCompute values based on conditions:\n```prolog\ndiscount_rate(Name, Price, Discount) :-\n    products(_, Name, Price, _, Category),\n    Discount = sql_case([\n        when(Category = 'Electronics', Price * 0.15),\n        when(Category = 'Clothing', Price * 0.20),\n        when(Category = 'Books', Price * 0.10)\n    ], Price * 0.05).\n```\n\nUse `sql_as/2` for column aliases:\n```prolog\nTier = sql_as(sql_case([...], 'Default'), salary_tier)\n```", "answer_tailored": true}
